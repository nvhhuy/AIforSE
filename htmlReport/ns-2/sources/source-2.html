


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > BookingServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.luxestay.hotel.service.impl</a>
</div>

<h1>Coverage Summary for Class: BookingServiceImpl (com.luxestay.hotel.service.impl)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">BookingServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/52)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/82)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.luxestay.hotel.service.impl;
&nbsp;
&nbsp;import com.luxestay.hotel.dto.PagedResponse;
&nbsp;import com.luxestay.hotel.dto.booking.*;
&nbsp;import com.luxestay.hotel.model.Account;
&nbsp;import com.luxestay.hotel.model.entity.BookingEntity;
&nbsp;import com.luxestay.hotel.model.entity.RoomEntity;
&nbsp;import com.luxestay.hotel.repository.*;
&nbsp;import com.luxestay.hotel.service.BookingService;
&nbsp;import jakarta.persistence.EntityNotFoundException;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import org.springframework.data.domain.*;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;
&nbsp;import java.math.BigDecimal;
&nbsp;import java.time.*;
&nbsp;import java.time.temporal.ChronoUnit;
&nbsp;import java.util.List;
&nbsp;
&nbsp;@Service
&nbsp;@RequiredArgsConstructor
&nbsp;public class BookingServiceImpl implements BookingService {
&nbsp;
&nbsp;    private final BookingRepository bookingRepository;
&nbsp;    private final RoomRepository roomRepository;
&nbsp;    private final AccountRepository accountRepository;
&nbsp;
&nbsp;    private static final int CANCEL_FREE_HOURS = 24; // b?n tùy ch?nh
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public BookingResponse create(Integer accountId, BookingRequest req) {
<b class="nc">&nbsp;        if (req.getRoomId() == null) throw new IllegalArgumentException(&quot;Thi?u roomId&quot;);</b>
<b class="nc">&nbsp;        if (req.getCheckIn() == null || req.getCheckOut() == null)</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;Thi?u ngày nh?n/tr?&quot;);</b>
<b class="nc">&nbsp;        LocalDate in  = LocalDate.parse(req.getCheckIn());</b>
<b class="nc">&nbsp;        LocalDate out = LocalDate.parse(req.getCheckOut());</b>
<b class="nc">&nbsp;        if (!out.isAfter(in)) throw new IllegalArgumentException(&quot;Ngày tr? ph?i sau ngày nh?n&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        RoomEntity room = roomRepository.findById(req.getRoomId().intValue())</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Không tìm th?y phòng&quot;));</b>
<b class="nc">&nbsp;        Account acc = accountRepository.findById(accountId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Không tìm th?y tài kho?n&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        long nights = Math.max(1, ChronoUnit.DAYS.between(in, out));</b>
<b class="nc">&nbsp;        int price = room.getPricePerNight() == null ? 0 : room.getPricePerNight();</b>
<b class="nc">&nbsp;        BigDecimal total = BigDecimal.valueOf(price).multiply(BigDecimal.valueOf(nights));</b>
&nbsp;
<b class="nc">&nbsp;        BookingEntity b = new BookingEntity();</b>
<b class="nc">&nbsp;        b.setAccount(acc);</b>
<b class="nc">&nbsp;        b.setRoom(room);</b>
<b class="nc">&nbsp;        b.setCheckIn(in);</b>
<b class="nc">&nbsp;        b.setCheckOut(out);</b>
<b class="nc">&nbsp;        b.setTotalPrice(total);</b>
<b class="nc">&nbsp;        b.setStatus(&quot;pending&quot;); // ho?c confirmed sau thanh toán</b>
<b class="nc">&nbsp;        b.setCreatedAt(LocalDateTime.now());</b>
&nbsp;
<b class="nc">&nbsp;        bookingRepository.save(b);</b>
<b class="nc">&nbsp;        return new BookingResponse(b.getId(), b.getStatus(), total.intValue());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void requestCancel(Integer bookingId, Integer accountId, String reason) {
<b class="nc">&nbsp;        BookingEntity b = bookingRepository.findByIdAndAccount_Id(bookingId, accountId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Không tìm th?y ??t phòng&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        String st = (b.getStatus()==null?&quot;pending&quot;:b.getStatus()).toLowerCase();</b>
<b class="nc">&nbsp;        if (st.equals(&quot;cancellation_requested&quot;))</b>
<b class="nc">&nbsp;            throw new IllegalStateException(&quot;B?n ?ã g?i yêu c?u h?y, vui lòng ch? duy?t&quot;);</b>
<b class="nc">&nbsp;        if (st.equals(&quot;cancelled&quot;))</b>
<b class="nc">&nbsp;            throw new IllegalStateException(&quot;??n ?ã h?y&quot;);</b>
<b class="nc">&nbsp;        if (st.equals(&quot;checked_in&quot;) || st.equals(&quot;checked_out&quot;))</b>
<b class="nc">&nbsp;            throw new IllegalStateException(&quot;Không th? h?y khi ?ã nh?n/tr? phòng&quot;);</b>
&nbsp;
&nbsp;        // ki?m tra h?n chót h?y mi?n phí (không block, ch? tham kh?o; mu?n block -&gt; throw)
<b class="nc">&nbsp;        if (b.getCheckIn() != null) {</b>
<b class="nc">&nbsp;            LocalDateTime deadline = b.getCheckIn().atStartOfDay().minusHours(CANCEL_FREE_HOURS);</b>
<b class="nc">&nbsp;            if (LocalDateTime.now().isAfter(deadline)) {</b>
&nbsp;                // có th? ghi thêm note “Tr? h?n”
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        b.setStatus(&quot;cancel_requested&quot;);</b>
<b class="nc">&nbsp;        b.setCancelReason(reason);</b>
<b class="nc">&nbsp;        b.setCancelRequestedAt(LocalDateTime.now());</b>
<b class="nc">&nbsp;        bookingRepository.save(b);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void decideCancel(Integer bookingId, Integer staffId, boolean approve, String note) {
<b class="nc">&nbsp;        BookingEntity b = bookingRepository.findById(bookingId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Không tìm th?y ??t phòng&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        if (!&quot;cancel_requested&quot;.equalsIgnoreCase(b.getStatus())) {</b>
<b class="nc">&nbsp;            throw new IllegalStateException(&quot;??n không ? tr?ng thái ch? h?y&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (approve) {</b>
<b class="nc">&nbsp;            b.setStatus(&quot;cancelled&quot;);</b>
<b class="nc">&nbsp;            b.setCancelApprovedBy(staffId);</b>
<b class="nc">&nbsp;            b.setCancelApprovedAt(LocalDateTime.now());</b>
<b class="nc">&nbsp;            if (note != null &amp;&amp; !note.isBlank()) {</b>
<b class="nc">&nbsp;                b.setCancelReason(append(b.getCancelReason(), &quot;Staff note: &quot; + note));</b>
&nbsp;            }
&nbsp;        } else {
&nbsp;            // t? ch?i: quay v? confirmed (ho?c pending tùy nghi?p v?)
<b class="nc">&nbsp;            b.setStatus(&quot;confirmed&quot;);</b>
<b class="nc">&nbsp;            if (note != null &amp;&amp; !note.isBlank()) {</b>
<b class="nc">&nbsp;                b.setCancelReason(append(b.getCancelReason(), &quot;Reject: &quot; + note));</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        bookingRepository.save(b);</b>
&nbsp;    }
&nbsp;
&nbsp;    private String append(String base, String extra) {
<b class="nc">&nbsp;        if (base == null || base.isBlank()) return extra;</b>
<b class="nc">&nbsp;        return base + &quot;\n&quot; + extra;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional(readOnly = true)
&nbsp;    public PagedResponse&lt;BookingSummary&gt; history(Integer accountId, String status, Integer page, Integer size) {
<b class="nc">&nbsp;        int p = page == null ? 0 : Math.max(0, page);</b>
<b class="nc">&nbsp;        int s = size == null ? 10 : Math.max(1, size);</b>
<b class="nc">&nbsp;        Pageable pageable = PageRequest.of(p, s);</b>
&nbsp;
<b class="nc">&nbsp;        var pg = bookingRepository.findForHistory(accountId, status, pageable);</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;BookingSummary&gt; items = pg.getContent().stream().map(b -&gt; {</b>
<b class="nc">&nbsp;            BookingSummary dto = new BookingSummary();</b>
<b class="nc">&nbsp;            dto.setId(b.getId());</b>
<b class="nc">&nbsp;            dto.setRoomId(b.getRoom()!=null? b.getRoom().getId(): null);</b>
<b class="nc">&nbsp;            dto.setRoomName(b.getRoom()!=null? b.getRoom().getRoomName(): null);</b>
<b class="nc">&nbsp;            dto.setCheckIn(b.getCheckIn());</b>
<b class="nc">&nbsp;            dto.setCheckOut(b.getCheckOut());</b>
<b class="nc">&nbsp;            dto.setTotalPrice(b.getTotalPrice());</b>
<b class="nc">&nbsp;            dto.setStatus(b.getStatus());</b>
&nbsp;//            dto.setCreatedAt(b.getCreatedAt());
<b class="nc">&nbsp;            return dto;</b>
<b class="nc">&nbsp;        }).toList();</b>
&nbsp;
<b class="nc">&nbsp;        return new PagedResponse&lt;&gt;(items, (int)pg.getTotalElements(), pg.getNumber(), pg.getSize());</b>
&nbsp;    }
&nbsp;    @Transactional
&nbsp;    @Override
&nbsp;    public void confirmBookingPayment(int bookingId) {
&nbsp;
<b class="nc">&nbsp;        BookingEntity booking = bookingRepository.findById(bookingId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Booking not found: &quot; + bookingId));</b>
&nbsp;
<b class="nc">&nbsp;        if (&quot;pending&quot;.equalsIgnoreCase(booking.getStatus())) {</b>
&nbsp;
&nbsp;            // 1. C?p nh?t booking
<b class="nc">&nbsp;            booking.setStatus(&quot;confirmed&quot;);</b>
<b class="nc">&nbsp;            bookingRepository.save(booking);</b>
&nbsp;
&nbsp;            // 2. C?p nh?t phòng
<b class="nc">&nbsp;            RoomEntity room = booking.getRoom();</b>
<b class="nc">&nbsp;            if (room != null) {</b>
<b class="nc">&nbsp;                room.setStatus(&quot;occupied&quot;);</b>
<b class="nc">&nbsp;                roomRepository.save(room);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                throw new IllegalStateException(&quot;Booking &quot; + bookingId + &quot; has no room associated.&quot;);</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            System.out.println(&quot;Booking &quot; + bookingId + &quot; status is already confirmed.&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-10-25 10:13</div>
</div>
</body>
</html>
