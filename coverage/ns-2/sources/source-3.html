


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > RoomServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.luxestay.hotel.service.impl</a>
</div>

<h1>Coverage Summary for Class: RoomServiceImpl (com.luxestay.hotel.service.impl)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">RoomServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/165)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/286)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.luxestay.hotel.service.impl;
&nbsp;
&nbsp;import com.luxestay.hotel.dto.PagedResponse;
&nbsp;import com.luxestay.hotel.dto.RoomAvailabilityRequest;
&nbsp;import com.luxestay.hotel.dto.RoomDetail;
&nbsp;import com.luxestay.hotel.dto.RoomImageRequest;
&nbsp;import com.luxestay.hotel.dto.RoomRecommendRequest;
&nbsp;import com.luxestay.hotel.dto.RoomRequest;
&nbsp;import com.luxestay.hotel.dto.RoomSearchCriteria;
&nbsp;import com.luxestay.hotel.mapper.RoomMapper;
&nbsp;import com.luxestay.hotel.model.Review;
&nbsp;import com.luxestay.hotel.model.Room;
&nbsp;import com.luxestay.hotel.model.entity.BedLayout;
&nbsp;import com.luxestay.hotel.model.entity.RoomEntity;
&nbsp;import com.luxestay.hotel.model.entity.RoomImage;
&nbsp;import com.luxestay.hotel.repository.BedLayoutRepository;
&nbsp;import com.luxestay.hotel.repository.BookingRepository;
&nbsp;import com.luxestay.hotel.repository.RoomImageRepository;
&nbsp;import com.luxestay.hotel.repository.RoomRepository;
&nbsp;import com.luxestay.hotel.service.RoomService;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import org.springframework.data.domain.*;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;
&nbsp;import java.time.LocalDate;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.*;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;@Service
&nbsp;@RequiredArgsConstructor
&nbsp;public class RoomServiceImpl implements RoomService {
&nbsp;
&nbsp;    private final RoomRepository roomRepository;
&nbsp;    private final RoomImageRepository roomImageRepository;
&nbsp;    private final BedLayoutRepository bedLayoutRepository;
&nbsp;    private final BookingRepository bookingRepository;
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;Room&gt; listRooms() {
&nbsp;        // Ch? hi?n th? phòng available và visible cho trang ch?
<b class="nc">&nbsp;        Page&lt;RoomEntity&gt; page = roomRepository.findForList(</b>
<b class="nc">&nbsp;                List.of(&quot;available&quot;),</b>
&nbsp;                null,
&nbsp;                null,
&nbsp;                null,
&nbsp;                null,
<b class="nc">&nbsp;                PageRequest.of(0, 50, Sort.by(&quot;pricePerNight&quot;).ascending()));</b>
&nbsp;
<b class="nc">&nbsp;        return page.getContent().stream()</b>
<b class="nc">&nbsp;                .filter(r -&gt; Boolean.TRUE.equals(r.getIsVisible()))</b>
<b class="nc">&nbsp;                .map(RoomMapper::toDto)</b>
<b class="nc">&nbsp;                .toList();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;Room&gt; listAllRoomsForAdmin() {
&nbsp;        // Tr? v? T?T C? phòng cho admin (k? c? hidden)
<b class="nc">&nbsp;        Page&lt;RoomEntity&gt; page = roomRepository.findForList(</b>
<b class="nc">&nbsp;                List.of(&quot;available&quot;, &quot;occupied&quot;, &quot;maintenance&quot;),</b>
&nbsp;                null,
&nbsp;                null,
&nbsp;                null,
&nbsp;                null,
<b class="nc">&nbsp;                PageRequest.of(0, 100, Sort.by(&quot;id&quot;).ascending()));</b>
&nbsp;
<b class="nc">&nbsp;        return page.getContent().stream()</b>
<b class="nc">&nbsp;                .map(RoomMapper::toDto)</b>
<b class="nc">&nbsp;                .toList();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PagedResponse&lt;Room&gt; search(RoomSearchCriteria c) {
<b class="nc">&nbsp;        Sort sort = switch (String.valueOf(c.getSort()).toLowerCase()) {</b>
<b class="nc">&nbsp;            case &quot;pricedesc&quot; -&gt; Sort.by(&quot;pricePerNight&quot;).descending();</b>
<b class="nc">&nbsp;            case &quot;ratingdesc&quot; -&gt; Sort.by(&quot;pricePerNight&quot;).ascending(); // t?m</b>
<b class="nc">&nbsp;            default -&gt; Sort.by(&quot;pricePerNight&quot;).ascending();</b>
&nbsp;        };
&nbsp;
<b class="nc">&nbsp;        Pageable pageable = PageRequest.of(</b>
<b class="nc">&nbsp;                Optional.ofNullable(c.getPage()).orElse(0),</b>
<b class="nc">&nbsp;                Optional.ofNullable(c.getSize()).orElse(10),</b>
&nbsp;                sort);
&nbsp;
<b class="nc">&nbsp;        List&lt;String&gt; layoutNames = (c.getTypes() == null || c.getTypes().isEmpty()) ? null : c.getTypes();</b>
<b class="nc">&nbsp;        List&lt;String&gt; statusList = (c.getStatus() == null || c.getStatus().isEmpty()) ? null : c.getStatus();</b>
<b class="nc">&nbsp;        String q = null;</b>
&nbsp;
<b class="nc">&nbsp;        Page&lt;RoomEntity&gt; page = roomRepository.findForList(</b>
&nbsp;                statusList,
&nbsp;                layoutNames,
<b class="nc">&nbsp;                c.getPriceMin(),</b>
<b class="nc">&nbsp;                c.getPriceMax(),</b>
&nbsp;                q,
&nbsp;                pageable);
&nbsp;
<b class="nc">&nbsp;        List&lt;RoomEntity&gt; list = new ArrayList&lt;&gt;(page.getContent());</b>
&nbsp;
&nbsp;        // l?c capacity theo guests
<b class="nc">&nbsp;        if (c.getGuests() != null) {</b>
<b class="nc">&nbsp;            list = list.stream()</b>
<b class="nc">&nbsp;                    .filter(r -&gt; r.getCapacity() != null &amp;&amp; r.getCapacity() &gt;= c.getGuests())</b>
<b class="nc">&nbsp;                    .toList();</b>
&nbsp;        }
&nbsp;
&nbsp;        // l?c amenities (ít nh?t 1 trùng)
<b class="nc">&nbsp;        if (c.getAmenities() != null &amp;&amp; !c.getAmenities().isEmpty()) {</b>
<b class="nc">&nbsp;            Set&lt;String&gt; need = c.getAmenities().stream()</b>
<b class="nc">&nbsp;                    .map(s -&gt; s.toLowerCase(Locale.ROOT)).collect(Collectors.toSet());</b>
<b class="nc">&nbsp;            list = list.stream().filter(r -&gt; {</b>
<b class="nc">&nbsp;                String am = Optional.ofNullable(r.getAmenities()).orElse(&quot;&quot;);</b>
<b class="nc">&nbsp;                for (String token : am.split(&quot;[;,]&quot;)) {</b>
<b class="nc">&nbsp;                    if (need.contains(token.trim().toLowerCase(Locale.ROOT)))</b>
<b class="nc">&nbsp;                        return true;</b>
&nbsp;                }
<b class="nc">&nbsp;                return false;</b>
<b class="nc">&nbsp;            }).toList();</b>
&nbsp;        }
&nbsp;
&nbsp;        // ch? l?y phòng visible
<b class="nc">&nbsp;        list = list.stream()</b>
<b class="nc">&nbsp;                .filter(r -&gt; Boolean.TRUE.equals(r.getIsVisible()))</b>
<b class="nc">&nbsp;                .toList();</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;Room&gt; items = list.stream().map(RoomMapper::toDto).toList();</b>
<b class="nc">&nbsp;        return new PagedResponse&lt;&gt;(items, (int) page.getTotalElements(), page.getNumber(), page.getSize());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PagedResponse&lt;Room&gt; checkAvailability(RoomAvailabilityRequest req) {
&nbsp;        // Validate dates
<b class="nc">&nbsp;        if (req.getCheckIn() == null || req.getCheckOut() == null) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;CheckIn và CheckOut không ???c ?? tr?ng&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (req.getCheckIn().isAfter(req.getCheckOut())) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;CheckIn ph?i tr??c CheckOut&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (req.getCheckIn().isBefore(LocalDate.now())) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;CheckIn ph?i t? hôm nay tr? ?i&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Pageable pageable = PageRequest.of(0, 50, Sort.by(&quot;pricePerNight&quot;).ascending());</b>
&nbsp;
<b class="nc">&nbsp;        Page&lt;RoomEntity&gt; page = roomRepository.findAvailableRooms(</b>
<b class="nc">&nbsp;                req.getCheckIn(),</b>
<b class="nc">&nbsp;                req.getCheckOut(),</b>
<b class="nc">&nbsp;                req.getGuests(),</b>
<b class="nc">&nbsp;                req.getPriceMin(),</b>
<b class="nc">&nbsp;                req.getPriceMax(),</b>
&nbsp;                pageable);
&nbsp;
<b class="nc">&nbsp;        List&lt;Room&gt; items = page.getContent().stream()</b>
<b class="nc">&nbsp;                .filter(r -&gt; Boolean.TRUE.equals(r.getIsVisible()))</b>
<b class="nc">&nbsp;                .map(RoomMapper::toDto)</b>
<b class="nc">&nbsp;                .toList();</b>
<b class="nc">&nbsp;        return new PagedResponse&lt;&gt;(items, (int) page.getTotalElements(), page.getNumber(), page.getSize());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public RoomDetail getDetail(Long id) {
<b class="nc">&nbsp;        RoomEntity e = roomRepository.findById(id.intValue())</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Room not found&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        Room room = RoomMapper.toDto(e);</b>
<b class="nc">&nbsp;        room.setRating(4.7);</b>
<b class="nc">&nbsp;        room.setReviews(120);</b>
&nbsp;
&nbsp;        // l?y gallery t? DB; n?u r?ng thì fallback
<b class="nc">&nbsp;        List&lt;RoomImage&gt; imgs = roomImageRepository</b>
<b class="nc">&nbsp;                .findByRoom_IdOrderByIsPrimaryDescSortOrderAsc(e.getId());</b>
&nbsp;        List&lt;String&gt; gallery;
<b class="nc">&nbsp;        if (!imgs.isEmpty()) {</b>
<b class="nc">&nbsp;            gallery = imgs.stream().map(RoomImage::getImageUrl).toList();</b>
<b class="nc">&nbsp;            room.setImageUrl(gallery.get(0));</b>
<b class="nc">&nbsp;        } else if (room.getImageUrl() != null &amp;&amp; !room.getImageUrl().isBlank()) {</b>
<b class="nc">&nbsp;            gallery = List.of(room.getImageUrl());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            gallery = List.of(&quot;/assets/placeholder-room.jpg&quot;);</b>
<b class="nc">&nbsp;            room.setImageUrl(gallery.get(0));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        RoomDetail d = new RoomDetail();</b>
<b class="nc">&nbsp;        d.setRoom(room);</b>
<b class="nc">&nbsp;        d.setFloorRange(&quot;T?ng 2-5&quot;);</b>
<b class="nc">&nbsp;        d.setDescription(Optional.ofNullable(e.getDescription())</b>
<b class="nc">&nbsp;                .orElse(&quot;Phòng &quot; + room.getName() + &quot; trang b? ??y ?? ti?n nghi, phù h?p ngh? d??ng/công tác.&quot;));</b>
<b class="nc">&nbsp;        d.setHighlights(Arrays.asList(room.getAmenities() != null ? room.getAmenities() : new String[0]));</b>
<b class="nc">&nbsp;        d.setGallery(gallery);</b>
<b class="nc">&nbsp;        d.setAmenities(Map.of(</b>
<b class="nc">&nbsp;                &quot;Ti?n nghi c? b?n&quot;, List.of(&quot;WiFi mi?n phí&quot;, &quot;?i?u hòa&quot;, &quot;TV&quot;, &quot;Két an toàn&quot;),</b>
<b class="nc">&nbsp;                &quot;Phòng t?m&quot;, List.of(&quot;Vòi sen&quot;, &quot;?? dùng t?m&quot;),</b>
<b class="nc">&nbsp;                &quot;D?ch v?&quot;, List.of(&quot;Gi?t ?i&quot;, &quot;D?n phòng&quot;)));</b>
<b class="nc">&nbsp;        d.setRatingHistogram(Map.of(5, 78, 4, 32, 3, 10, 2, 3, 1, 1));</b>
<b class="nc">&nbsp;        d.setReviews(List.of(</b>
&nbsp;                new Review(&quot;Khách ?n Danh&quot;, &quot;https://i.pravatar.cc/64?img=1&quot;, 5, &quot;Phòng s?ch ??p, ?úng mô t?.&quot;,
&nbsp;                        &quot;2 tu?n tr??c&quot;)));
<b class="nc">&nbsp;        return d;</b>
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     * =================================================================
&nbsp;     * ====== ADMIN CRUD OPERATIONS ======
&nbsp;     * =================================================================
&nbsp;     */
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public Room createRoom(RoomRequest req) {
&nbsp;        // Validate required fields
<b class="nc">&nbsp;        if (req.getRoomNumber() == null || req.getRoomNumber().isBlank()) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;Room number is required&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (req.getRoomName() == null || req.getRoomName().isBlank()) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;Room name is required&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (req.getPricePerNight() == null || req.getPricePerNight() &lt;= 0) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;Valid price is required&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Check if room number already exists
<b class="nc">&nbsp;        if (roomRepository.existsByRoomNumber(req.getRoomNumber())) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;Room number already exists&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        RoomEntity entity = new RoomEntity();</b>
<b class="nc">&nbsp;        entity.setRoomNumber(req.getRoomNumber());</b>
<b class="nc">&nbsp;        entity.setRoomName(req.getRoomName());</b>
<b class="nc">&nbsp;        entity.setPricePerNight(req.getPricePerNight());</b>
<b class="nc">&nbsp;        entity.setDescription(req.getDescription());</b>
<b class="nc">&nbsp;        entity.setAmenities(req.getAmenities());</b>
<b class="nc">&nbsp;        entity.setStatus(req.getStatus() != null ? req.getStatus() : &quot;available&quot;);</b>
<b class="nc">&nbsp;        entity.setCapacity(req.getCapacity() != null ? req.getCapacity() : 2);</b>
<b class="nc">&nbsp;        entity.setImageUrl(req.getImageUrl());</b>
<b class="nc">&nbsp;        entity.setCreatedAt(LocalDateTime.now());</b>
&nbsp;
&nbsp;        // Set bed layout if provided
<b class="nc">&nbsp;        if (req.getBedLayoutId() != null) {</b>
<b class="nc">&nbsp;            BedLayout bedLayout = bedLayoutRepository.findById(req.getBedLayoutId())</b>
<b class="nc">&nbsp;                    .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Bed layout not found&quot;));</b>
<b class="nc">&nbsp;            entity.setBedLayout(bedLayout);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        entity = roomRepository.save(entity);</b>
&nbsp;
&nbsp;        // Add images if provided
<b class="nc">&nbsp;        if (req.getImages() != null &amp;&amp; !req.getImages().isEmpty()) {</b>
<b class="nc">&nbsp;            addImages(Long.valueOf(entity.getId()), req.getImages());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return RoomMapper.toDto(entity);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public Room updateRoom(Long id, RoomRequest req) {
<b class="nc">&nbsp;        RoomEntity entity = roomRepository.findById(id.intValue())</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Room not found&quot;));</b>
&nbsp;
&nbsp;        // Update fields if provided
<b class="nc">&nbsp;        if (req.getRoomNumber() != null &amp;&amp; !req.getRoomNumber().isBlank()) {</b>
<b class="nc">&nbsp;            if (!entity.getRoomNumber().equals(req.getRoomNumber()) &amp;&amp;</b>
<b class="nc">&nbsp;                    roomRepository.existsByRoomNumber(req.getRoomNumber())) {</b>
<b class="nc">&nbsp;                throw new IllegalArgumentException(&quot;Room number already exists&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            entity.setRoomNumber(req.getRoomNumber());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (req.getRoomName() != null &amp;&amp; !req.getRoomName().isBlank()) {</b>
<b class="nc">&nbsp;            entity.setRoomName(req.getRoomName());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (req.getPricePerNight() != null) {</b>
<b class="nc">&nbsp;            if (req.getPricePerNight() &lt;= 0) {</b>
<b class="nc">&nbsp;                throw new IllegalArgumentException(&quot;Price must be positive&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            entity.setPricePerNight(req.getPricePerNight());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (req.getDescription() != null) {</b>
<b class="nc">&nbsp;            entity.setDescription(req.getDescription());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (req.getAmenities() != null) {</b>
<b class="nc">&nbsp;            entity.setAmenities(req.getAmenities());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (req.getStatus() != null) {</b>
<b class="nc">&nbsp;            entity.setStatus(req.getStatus());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (req.getCapacity() != null) {</b>
<b class="nc">&nbsp;            entity.setCapacity(req.getCapacity());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (req.getImageUrl() != null) {</b>
<b class="nc">&nbsp;            entity.setImageUrl(req.getImageUrl());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (req.getBedLayoutId() != null) {</b>
<b class="nc">&nbsp;            BedLayout bedLayout = bedLayoutRepository.findById(req.getBedLayoutId())</b>
<b class="nc">&nbsp;                    .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Bed layout not found&quot;));</b>
<b class="nc">&nbsp;            entity.setBedLayout(bedLayout);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        entity = roomRepository.save(entity);</b>
&nbsp;
&nbsp;        // Update images if provided
<b class="nc">&nbsp;        if (req.getImages() != null &amp;&amp; !req.getImages().isEmpty()) {</b>
<b class="nc">&nbsp;            addImages(id, req.getImages());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return RoomMapper.toDto(entity);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void deleteRoom(Long id) {
<b class="nc">&nbsp;        RoomEntity entity = roomRepository.findById(id.intValue())</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Room not found&quot;));</b>
&nbsp;        // Soft delete
<b class="nc">&nbsp;        entity.setStatus(&quot;deleted&quot;);</b>
<b class="nc">&nbsp;        roomRepository.save(entity);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void toggleVisibility(Long id, Boolean isVisible) {
<b class="nc">&nbsp;        RoomEntity entity = roomRepository.findById(id.intValue())</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Room not found&quot;));</b>
<b class="nc">&nbsp;        entity.setIsVisible(isVisible);</b>
<b class="nc">&nbsp;        roomRepository.save(entity);</b>
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     * ====== Qu?n lý ?nh (add / setPrimary / delete)
&nbsp;     */
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;String&gt; addImages(Long roomId, List&lt;RoomImageRequest&gt; images) {
<b class="nc">&nbsp;        var room = roomRepository.findById(roomId.intValue())</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Room not found&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        if (images == null || images.isEmpty()) {</b>
<b class="nc">&nbsp;            return List.of();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        boolean hasPrimaryInRequest = images.stream().anyMatch(x -&gt; Boolean.TRUE.equals(x.getPrimary()));</b>
<b class="nc">&nbsp;        if (hasPrimaryInRequest) {</b>
<b class="nc">&nbsp;            var exist = roomImageRepository.findByRoom_IdOrderByIsPrimaryDescSortOrderAsc(room.getId());</b>
<b class="nc">&nbsp;            exist.forEach(i -&gt; {</b>
<b class="nc">&nbsp;                if (Boolean.TRUE.equals(i.getIsPrimary())) i.setIsPrimary(false);</b>
&nbsp;            });
<b class="nc">&nbsp;            roomImageRepository.saveAll(exist);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        int autoOrder = 1;</b>
<b class="nc">&nbsp;        List&lt;String&gt; gallery = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (var req : images) {</b>
<b class="nc">&nbsp;            if (req.getImageUrl() == null || req.getImageUrl().isBlank()) continue;</b>
<b class="nc">&nbsp;            var img = new RoomImage();</b>
<b class="nc">&nbsp;            img.setRoom(room);</b>
<b class="nc">&nbsp;            img.setImageUrl(req.getImageUrl().trim());</b>
<b class="nc">&nbsp;            img.setIsPrimary(Boolean.TRUE.equals(req.getPrimary()));</b>
<b class="nc">&nbsp;            img.setSortOrder(req.getSortOrder() != null ? req.getSortOrder() : autoOrder++);</b>
<b class="nc">&nbsp;            roomImageRepository.save(img);</b>
<b class="nc">&nbsp;            gallery.add(img.getImageUrl());</b>
<b class="nc">&nbsp;            if (img.getIsPrimary()) room.setImageUrl(img.getImageUrl());</b>
&nbsp;        }
<b class="nc">&nbsp;        roomRepository.save(room);</b>
<b class="nc">&nbsp;        return gallery;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void setPrimaryImage(Long roomId, Integer imageId) {
<b class="nc">&nbsp;        var room = roomRepository.findById(roomId.intValue())</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Room not found&quot;));</b>
<b class="nc">&nbsp;        var all = roomImageRepository.findByRoom_IdOrderByIsPrimaryDescSortOrderAsc(room.getId());</b>
<b class="nc">&nbsp;        all.forEach(i -&gt; i.setIsPrimary(false));</b>
<b class="nc">&nbsp;        roomImageRepository.saveAll(all);</b>
&nbsp;
<b class="nc">&nbsp;        var img = roomImageRepository.findById(imageId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Image not found&quot;));</b>
<b class="nc">&nbsp;        if (!img.getRoom().getId().equals(room.getId()))</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;Image does not belong to room&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        img.setIsPrimary(true);</b>
<b class="nc">&nbsp;        img.setSortOrder(0);</b>
<b class="nc">&nbsp;        roomImageRepository.save(img);</b>
<b class="nc">&nbsp;        room.setImageUrl(img.getImageUrl());</b>
<b class="nc">&nbsp;        roomRepository.save(room);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteImage(Long roomId, Integer imageId) {
<b class="nc">&nbsp;        var img = roomImageRepository.findById(imageId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Image not found&quot;));</b>
<b class="nc">&nbsp;        if (!img.getRoom().getId().equals(roomId.intValue()))</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;Image does not belong to room&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        boolean wasPrimary = Boolean.TRUE.equals(img.getIsPrimary());</b>
<b class="nc">&nbsp;        roomImageRepository.delete(img);</b>
&nbsp;
<b class="nc">&nbsp;        if (wasPrimary) {</b>
<b class="nc">&nbsp;            var remain = roomImageRepository.findByRoom_IdOrderByIsPrimaryDescSortOrderAsc(roomId.intValue());</b>
<b class="nc">&nbsp;            if (!remain.isEmpty()) {</b>
<b class="nc">&nbsp;                remain.get(0).setIsPrimary(true);</b>
<b class="nc">&nbsp;                roomImageRepository.save(remain.get(0));</b>
<b class="nc">&nbsp;                var room = roomRepository.findById(roomId.intValue()).orElseThrow();</b>
<b class="nc">&nbsp;                room.setImageUrl(remain.get(0).getImageUrl());</b>
<b class="nc">&nbsp;                roomRepository.save(room);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void updateRoomStatus(Long id, String newStatus, String reason) {
<b class="nc">&nbsp;        if (!newStatus.matches(&quot;available|occupied|maintenance&quot;)) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;Tr?ng thái không h?p l?: &quot; + newStatus);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        RoomEntity room = roomRepository.findById(id.intValue())</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Không tìm th?y phòng v?i ID: &quot; + id));</b>
&nbsp;
<b class="nc">&nbsp;        String currentStatus = room.getStatus();</b>
<b class="nc">&nbsp;        if (currentStatus.equals(newStatus)) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        validateStatusTransition(room, currentStatus, newStatus);</b>
&nbsp;
<b class="nc">&nbsp;        room.setStatus(newStatus);</b>
<b class="nc">&nbsp;        roomRepository.save(room);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void validateStatusTransition(RoomEntity room, String currentStatus, String newStatus) {
<b class="nc">&nbsp;        switch (currentStatus) {</b>
&nbsp;            case &quot;available&quot;:
<b class="nc">&nbsp;                if (newStatus.equals(&quot;occupied&quot;)) {</b>
<b class="nc">&nbsp;                    boolean hasActiveBooking = hasActiveBooking(room.getId());</b>
<b class="nc">&nbsp;                    if (!hasActiveBooking) {</b>
<b class="nc">&nbsp;                        throw new IllegalArgumentException(</b>
&nbsp;                                &quot;Không th? chuy?n sang &#39;occupied&#39;: Phòng ch?a có booking ?ang ho?t ??ng. &quot; +
&nbsp;                                        &quot;Tr?ng thái &#39;occupied&#39; ???c t? ??ng c?p nh?t khi có khách check-in.&quot;);
&nbsp;                    }
&nbsp;                }
&nbsp;                break;
&nbsp;
&nbsp;            case &quot;occupied&quot;:
<b class="nc">&nbsp;                if (newStatus.equals(&quot;maintenance&quot;)) {</b>
<b class="nc">&nbsp;                    throw new IllegalArgumentException(</b>
&nbsp;                            &quot;Không th? chuy?n tr?c ti?p t? &#39;occupied&#39; sang &#39;maintenance&#39;. &quot; +
&nbsp;                                    &quot;Vui lòng ch? khách checkout (tr?ng thái available) tr??c.&quot;);
&nbsp;                }
&nbsp;                break;
&nbsp;
&nbsp;            case &quot;maintenance&quot;:
<b class="nc">&nbsp;                if (newStatus.equals(&quot;occupied&quot;)) {</b>
<b class="nc">&nbsp;                    throw new IllegalArgumentException(</b>
&nbsp;                            &quot;Không th? chuy?n tr?c ti?p t? &#39;maintenance&#39; sang &#39;occupied&#39;. &quot; +
&nbsp;                                    &quot;Vui lòng ??t v? &#39;available&#39; tr??c, sau ?ó khách có th? booking.&quot;);
&nbsp;                }
&nbsp;                break;
&nbsp;
&nbsp;            default:
<b class="nc">&nbsp;                throw new IllegalArgumentException(&quot;Tr?ng thái hi?n t?i không h?p l?: &quot; + currentStatus);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;Room&gt; recommendRooms(RoomRecommendRequest req) {
<b class="nc">&nbsp;        String type = req.getType() != null ? req.getType().toLowerCase() : &quot;auto&quot;;</b>
<b class="nc">&nbsp;        int limit = req.getLimit() != null &amp;&amp; req.getLimit() &gt; 0 ? req.getLimit() : 5;</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;RoomEntity&gt; recommendedRooms = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        switch (type) {</b>
&nbsp;            case &quot;popular&quot;:
<b class="nc">&nbsp;                recommendedRooms = getTopBookedRooms(limit);</b>
&nbsp;                break;
&nbsp;            case &quot;top_rated&quot;:
<b class="nc">&nbsp;                recommendedRooms = getTopRatedRooms(limit);</b>
&nbsp;                break;
&nbsp;            case &quot;personalized&quot;:
<b class="nc">&nbsp;                if (req.getAccountId() != null) {</b>
<b class="nc">&nbsp;                    recommendedRooms = getPersonalizedRooms(req.getAccountId().intValue(), limit);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case &quot;auto&quot;:
&nbsp;            default:
&nbsp;                // Auto: Try personalized first, fallback to popular, then top rated, finally
&nbsp;                // available
<b class="nc">&nbsp;                if (req.getAccountId() != null) {</b>
<b class="nc">&nbsp;                    recommendedRooms = getPersonalizedRooms(req.getAccountId().intValue(), limit);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (recommendedRooms.isEmpty()) {</b>
<b class="nc">&nbsp;                    recommendedRooms = getTopBookedRooms(limit);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (recommendedRooms.isEmpty()) {</b>
<b class="nc">&nbsp;                    recommendedRooms = getTopRatedRooms(limit);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;        }
&nbsp;
&nbsp;        // Fallback to available rooms if no recommendations found
<b class="nc">&nbsp;        if (recommendedRooms.isEmpty()) {</b>
<b class="nc">&nbsp;            recommendedRooms = getAvailableRooms(limit);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Filter only visible rooms and convert to DTO
<b class="nc">&nbsp;        return recommendedRooms.stream()</b>
<b class="nc">&nbsp;                .filter(r -&gt; Boolean.TRUE.equals(r.getIsVisible()))</b>
<b class="nc">&nbsp;                .limit(limit)</b>
<b class="nc">&nbsp;                .map(RoomMapper::toDto)</b>
<b class="nc">&nbsp;                .collect(Collectors.toList());</b>
&nbsp;    }
&nbsp;
&nbsp;    private List&lt;RoomEntity&gt; getTopBookedRooms(int limit) {
&nbsp;        try {
<b class="nc">&nbsp;            List&lt;Object[]&gt; stats = bookingRepository.countBookingsByRoom();</b>
<b class="nc">&nbsp;            if (stats.isEmpty()) {</b>
<b class="nc">&nbsp;                return new ArrayList&lt;&gt;();</b>
&nbsp;            }
&nbsp;
&nbsp;            // Extract room IDs sorted by booking count
<b class="nc">&nbsp;            List&lt;Integer&gt; topRoomIds = stats.stream()</b>
<b class="nc">&nbsp;                    .limit(limit * 2) // Get more than needed in case some are hidden</b>
<b class="nc">&nbsp;                    .map(row -&gt; (Integer) row[0])</b>
<b class="nc">&nbsp;                    .collect(Collectors.toList());</b>
&nbsp;
<b class="nc">&nbsp;            if (topRoomIds.isEmpty()) {</b>
<b class="nc">&nbsp;                return new ArrayList&lt;&gt;();</b>
&nbsp;            }
&nbsp;
&nbsp;            // Fetch rooms by IDs
<b class="nc">&nbsp;            return roomRepository.findAllById(topRoomIds).stream()</b>
<b class="nc">&nbsp;                    .filter(r -&gt; &quot;available&quot;.equals(r.getStatus()))</b>
<b class="nc">&nbsp;                    .collect(Collectors.toList());</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            System.err.println(&quot;Error getting top booked rooms: &quot; + e.getMessage());</b>
<b class="nc">&nbsp;            return new ArrayList&lt;&gt;();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private List&lt;RoomEntity&gt; getTopRatedRooms(int limit) {
&nbsp;        // For now, return empty - will implement when ReviewRepository is properly
&nbsp;        // integrated
&nbsp;        // This requires joining reviews with bookings and rooms
<b class="nc">&nbsp;        return new ArrayList&lt;&gt;();</b>
&nbsp;    }
&nbsp;
&nbsp;    private List&lt;RoomEntity&gt; getPersonalizedRooms(Integer accountId, int limit) {
&nbsp;        try {
&nbsp;            // Find user&#39;s preferred room types (bed layouts) based on booking history
<b class="nc">&nbsp;            List&lt;Object[]&gt; preferences = bookingRepository.findUserPreferredRoomTypes(accountId);</b>
<b class="nc">&nbsp;            if (preferences.isEmpty()) {</b>
<b class="nc">&nbsp;                return new ArrayList&lt;&gt;();</b>
&nbsp;            }
&nbsp;
&nbsp;            // Get the most preferred bed layout ID
<b class="nc">&nbsp;            Integer preferredLayoutId = (Integer) preferences.get(0)[0];</b>
&nbsp;
&nbsp;            // Find available rooms with that bed layout
<b class="nc">&nbsp;            Page&lt;RoomEntity&gt; rooms = roomRepository.findForList(</b>
<b class="nc">&nbsp;                    List.of(&quot;available&quot;),</b>
&nbsp;                    null, // layoutNames (we&#39;ll filter by ID below)
&nbsp;                    null, // minPrice
&nbsp;                    null, // maxPrice
&nbsp;                    null, // q
<b class="nc">&nbsp;                    PageRequest.of(0, limit * 2, Sort.by(&quot;pricePerNight&quot;).ascending()));</b>
&nbsp;
<b class="nc">&nbsp;            return rooms.getContent().stream()</b>
<b class="nc">&nbsp;                    .filter(r -&gt; r.getBedLayout() != null &amp;&amp; r.getBedLayout().getId().equals(preferredLayoutId))</b>
<b class="nc">&nbsp;                    .limit(limit)</b>
<b class="nc">&nbsp;                    .collect(Collectors.toList());</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            System.err.println(&quot;Error getting personalized rooms: &quot; + e.getMessage());</b>
<b class="nc">&nbsp;            return new ArrayList&lt;&gt;();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private List&lt;RoomEntity&gt; getAvailableRooms(int limit) {
&nbsp;        // Fallback: Return available rooms sorted by price
<b class="nc">&nbsp;        Page&lt;RoomEntity&gt; page = roomRepository.findForList(</b>
<b class="nc">&nbsp;                List.of(&quot;available&quot;),</b>
&nbsp;                null, // layoutNames
&nbsp;                null, // minPrice
&nbsp;                null, // maxPrice
&nbsp;                null, // q
<b class="nc">&nbsp;                PageRequest.of(0, limit, Sort.by(&quot;pricePerNight&quot;).ascending()));</b>
&nbsp;
<b class="nc">&nbsp;        return page.getContent();</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean hasActiveBooking(Integer roomId) {
<b class="nc">&nbsp;        LocalDate today = LocalDate.now();</b>
<b class="nc">&nbsp;        return bookingRepository.existsByRoom_IdAndStatusInAndCheckOutAfter(</b>
&nbsp;                roomId,
<b class="nc">&nbsp;                List.of(&quot;confirmed&quot;, &quot;checked_in&quot;),</b>
&nbsp;                today);
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-10-25 10:37</div>
</div>
</body>
</html>
